# 前端架构

<cite>
**本文档引用文件**  
- [app/page.tsx](file://app/page.tsx)
- [lib/store/item-store.ts](file://lib/store/item-store.ts)
- [lib/hooks/use-items.ts](file://lib/hooks/use-items.ts)
- [lib/hooks/use-tags.ts](file://lib/hooks/use-tags.ts)
- [lib/api/client.ts](file://lib/api/client.ts)
- [lib/types/item.ts](file://lib/types/item.ts)
- [components/item-list.tsx](file://components/item-list.tsx)
- [components/item-form.tsx](file://components/item-form.tsx)
- [components/item-detail.tsx](file://components/item-detail.tsx)
- [components/tag-selector.tsx](file://components/tag-selector.tsx)
- [components/ui/index.ts](file://components/ui/index.ts)
</cite>

## 目录
1. [项目结构](#项目结构)
2. [组件架构](#组件架构)
3. [状态管理机制](#状态管理机制)
4. [路由系统](#路由系统)
5. [数据流与通信](#数据流与通信)
6. [自定义Hook](#自定义hook)
7. [组件依赖关系](#组件依赖关系)
8. [状态流示意图](#状态流示意图)

## 项目结构

记账应用的前端项目采用Next.js框架构建，遵循清晰的分层架构。项目根目录包含应用入口、组件库、业务逻辑和类型定义等核心模块。

```mermaid
graph TD
A[项目根目录] --> B[app]
A --> C[components]
A --> D[lib]
A --> E[.gitignore]
A --> F[README.md]
A --> G[package.json]
B --> B1[api]
B --> B2[globals.css]
B --> B3[layout.tsx]
B --> B4[page.tsx]
C --> C1[ui]
C --> C2[index.ts]
C --> C3[item-card.tsx]
C --> C4[item-list.tsx]
C --> C5[item-form.tsx]
C --> C6[item-detail.tsx]
C --> C7[tag-selector.tsx]
D --> D1[api]
D --> D2[auth]
D --> D3[db]
D --> D4[hooks]
D --> D5[store]
D --> D6[types]
D --> D7[utils]
D1 --> D1a[client.ts]
D4 --> D4a[use-items.ts]
D4 --> D4b[use-tags.ts]
D5 --> D5a[item-store.ts]
D6 --> D6a[item.ts]
D6 --> D6b[tag.ts]
```

**图示来源**  
- [app/page.tsx](file://app/page.tsx#L1-L275)
- [components/index.ts](file://components/index.ts#L1-L11)
- [lib/store/item-store.ts](file://lib/store/item-store.ts#L1-L114)

## 组件架构

前端组件架构采用分层设计，分为基础UI组件和业务组件两大类，实现关注点分离和代码复用。

### 基础UI组件

基础UI组件位于`components/ui`目录，基于shadcn/ui设计系统构建，提供标准化的界面元素。这些组件不包含业务逻辑，仅负责视觉呈现和基本交互。

```mermaid
classDiagram
class Button {
+variant : "default"|"outline"|"ghost"
+size : "sm"|"md"|"lg"
+children : ReactNode
+onClick : () => void
}
class Card {
+className : string
+children : ReactNode
}
class Input {
+type : string
+value : string
+onChange : (e) => void
+placeholder : string
}
class Dialog {
+open : boolean
+onOpenChange : (open) => void
+children : ReactNode
}
class Badge {
+variant : "default"|"secondary"|"destructive"
+children : ReactNode
}
Button <|-- Card : "包含"
Button <|-- Dialog : "包含"
Input <|-- Dialog : "包含"
Badge <|-- TagBadge : "扩展"
```

**图示来源**  
- [components/ui/index.ts](file://components/ui/index.ts#L1-L23)
- [components/tag-badge.tsx](file://components/tag-badge.tsx)

### 业务组件

业务组件位于`components`目录，封装特定功能的完整用户界面和交互逻辑。这些组件组合基础UI组件，实现具体业务场景。

```mermaid
classDiagram
class ItemList {
+items : Item[]
+onItemClick : (item) => void
+onFilterChange : (filter) => void
}
class ItemForm {
+item : Item | null
+onSubmit : (data, tagIds) => Promise
+onCancel : () => void
+initialTagIds : number[]
}
class ItemDetail {
+item : Item
+onEdit : () => void
+onArchive : () => void
+onUnarchive : () => void
+onDelete : () => void
+onClose : () => void
}
class TagSelector {
+selectedTagIds : number[]
+onChange : (tagIds) => void
}
ItemList --> ItemCard : "渲染多个"
ItemForm --> TagSelector : "包含"
ItemDetail --> TagBadge : "显示标签"
page.tsx --> ItemList : "使用"
page.tsx --> ItemForm : "条件渲染"
page.tsx --> ItemDetail : "条件渲染"
```

**图示来源**  
- [components/item-list.tsx](file://components/item-list.tsx#L1-L99)
- [components/item-form.tsx](file://components/item-form.tsx#L1-L216)
- [components/item-detail.tsx](file://components/item-detail.tsx#L1-L200)
- [components/tag-selector.tsx](file://components/tag-selector.tsx#L1-L177)

## 状态管理机制

前端采用Zustand作为状态管理解决方案，通过`item-store`集中管理物品数据和UI状态，实现全局状态的统一管理和高效更新。

### Zustand状态存储

`item-store`定义了物品管理所需的所有状态和操作方法，包括物品列表、筛选条件、表单状态和详情视图状态。

```mermaid
classDiagram
class ItemStore {
+items : Item[]
+filter : ItemFilter
+selectedItem : Item | null
+isFormOpen : boolean
+editingItem : Item | null
+isDetailOpen : boolean
+setItems(items)
+addItem(item)
+updateItem(id, item)
+removeItem(id)
+setFilter(filter)
+selectItem(item)
+openForm(item?)
+closeForm()
+openDetail(item)
+closeDetail()
+getFilteredItems()
}
ItemStore : 使用Zustand创建全局状态
ItemStore : 集中管理物品数据和UI状态
ItemStore : 提供状态更新方法
```

**图示来源**  
- [lib/store/item-store.ts](file://lib/store/item-store.ts#L1-L114)

### 状态结构设计

状态存储采用扁平化设计，将数据状态和UI状态分离但统一管理，确保状态的一致性和可预测性。

```mermaid
graph TD
A[ItemStore] --> B[数据状态]
A --> C[UI状态]
B --> B1[items: Item[]]
B --> B2[filter: ItemFilter]
C --> C1[isFormOpen: boolean]
C --> C2[editingItem: Item | null]
C --> C3[selectedItem: Item | null]
C --> C4[isDetailOpen: boolean]
D[操作方法] --> D1[setItems]
D --> D2[addItem]
D --> D3[updateItem]
D --> D4[removeItem]
D --> D5[openForm]
D --> D6[closeForm]
D --> D7[openDetail]
D --> D8[closeDetail]
D --> D9[setFilter]
A --> D
```

**图示来源**  
- [lib/store/item-store.ts](file://lib/store/item-store.ts#L9-L45)

## 路由系统

应用采用Next.js的App Router架构，通过文件系统定义路由，实现服务端渲染和客户端导航的无缝集成。

### 路由结构

路由系统主要由API路由和页面路由组成，API路由处理数据请求，页面路由管理用户界面。

```mermaid
graph TD
A[app] --> B[api]
A --> C[page.tsx]
A --> D[layout.tsx]
B --> B1[auth]
B --> B2[items]
B --> B3[tags]
B --> B4[user]
B1 --> B1a[login]
B1a --> B1a1[route.ts]
B2 --> B2a[[id]]
B2a --> B2a1[tags]
B2a1 --> B2a1a[route.ts]
B2a --> B2a2[route.ts]
B2 --> B2b[route.ts]
B3 --> B3a[[id]]
B3a --> B3a1[route.ts]
B3 --> B3b[route.ts]
B4 --> B4a[route.ts]
C --> 主页面
D --> 布局组件
```

**图示来源**  
- [app/page.tsx](file://app/page.tsx#L1-L275)
- [app/api](file://app/api)

### 主页面路由

主页面`page.tsx`是应用的入口点，负责初始化状态、处理认证和渲染核心组件。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant Page as "主页面"
participant Auth as "认证Hook"
participant Store as "物品状态"
participant ItemsApi as "物品API"
Client->>Page : 访问根路径
Page->>Auth : 检查认证状态
Auth-->>Page : 返回isAuthenticated
alt 未认证
Page-->>Client : 显示登录模态框
else 已认证
Page->>ItemsApi : 加载物品数据
ItemsApi-->>Page : 返回物品列表
Page->>Store : 设置物品列表
Page-->>Client : 渲染主界面
end
```

**图示来源**  
- [app/page.tsx](file://app/page.tsx#L6-L180)

## 数据流与通信

前端采用单向数据流模式，通过状态管理和自定义Hook实现组件间的高效通信和数据同步。

### 数据流模式

应用遵循"状态向下，事件向上"的设计原则，确保数据流动的可预测性和可维护性。

```mermaid
flowchart TD
A[状态管理器] --> |提供状态| B[页面组件]
B --> |传递属性| C[业务组件]
C --> |传递属性| D[基础UI组件]
D --> |触发事件| C
C --> |触发回调| B
B --> |调用状态方法| A
E[API客户端] --> |获取数据| A
A --> |更新状态| B
B --> |重新渲染| C
C --> |更新UI| D
```

**图示来源**  
- [app/page.tsx](file://app/page.tsx#L20-L275)
- [lib/store/item-store.ts](file://lib/store/item-store.ts#L47-L114)

### 组件通信机制

组件间通过属性传递和回调函数实现通信，避免直接依赖，提高组件的可复用性。

```mermaid
sequenceDiagram
participant Page as "主页面"
participant List as "物品列表"
participant Form as "物品表单"
participant Detail as "物品详情"
participant Store as "状态管理器"
Page->>Store : 订阅状态
Store-->>Page : 提供items, isFormOpen等
Page->>List : 传递items和回调函数
List->>Store : onItemClick触发openDetail
Store-->>Page : 更新selectedItem和isDetailOpen
Page->>Detail : 条件渲染详情组件
Detail->>Store : onEdit触发openForm
Store-->>Page : 更新editingItem和isFormOpen
Page->>Form : 条件渲染表单组件
Form->>Store : onSubmit后closeForm
Store-->>Page : 更新表单状态
```

**图示来源**  
- [app/page.tsx](file://app/page.tsx#L24-L39)
- [components/item-list.tsx](file://components/item-list.tsx#L20-L99)
- [components/item-detail.tsx](file://components/item-detail.tsx#L24-L200)
- [components/item-form.tsx](file://components/item-form.tsx#L24-L216)

## 自定义Hook

应用通过自定义Hook封装数据获取和业务逻辑，实现逻辑复用和关注点分离。

### useItems Hook

`use-items` Hook封装了物品数据的所有CRUD操作，与后端API进行交互。

```mermaid
classDiagram
class useItems {
+getAllItems(filter)
+getItemById(id)
+createItem(data)
+updateItem(id, data)
+deleteItem(id)
+archiveItem(id)
+unarchiveItem(id)
}
useItems --> api.client : "调用"
useItems --> ItemStore : "更新状态"
useItems : 封装物品数据操作
useItems : 处理错误和异常
useItems : 实现业务逻辑如归档计算
```

**图示来源**  
- [lib/hooks/use-items.ts](file://lib/hooks/use-items.ts#L1-L106)

### useTags Hook

`use-tags` Hook管理标签相关的数据操作，支持标签的创建、查询和关联。

```mermaid
classDiagram
class useTags {
+getAllTags()
+getTagById(id)
+createTag(data)
+updateTag(id, data)
+deleteTag(id)
+getItemTags(itemId)
+setItemTags(itemId, tagIds)
}
useTags --> api.client : "调用"
useTags --> TagSelector : "提供数据"
useTags : 封装标签操作
useTags : 管理物品-标签关联
```

**图示来源**  
- [lib/hooks/use-tags.ts](file://lib/hooks/use-tags.ts#L1-L98)

## 组件依赖关系

组件间存在清晰的依赖关系，形成层次化的组件树结构，确保应用的可维护性和可扩展性。

```mermaid
graph TD
A[app/page.tsx] --> B[useItemStore]
A --> C[useItems]
A --> D[useTags]
A --> E[useAuth]
A --> F[ItemList]
A --> G[ItemForm]
A --> H[ItemDetail]
A --> I[LoginModal]
A --> J[UserSettings]
F --> K[ItemCard]
G --> L[TagSelector]
H --> M[TagBadge]
L --> N[TagBadge]
L --> O[useTags]
B --> P[item-store.ts]
C --> Q[use-items.ts]
D --> R[use-tags.ts]
Q --> S[api/client.ts]
R --> S
E --> S
S --> T[NEXT_PUBLIC_API_URL]
```

**图示来源**  
- [app/page.tsx](file://app/page.tsx#L9-L17)
- [lib/hooks/use-items.ts](file://lib/hooks/use-items.ts#L7)
- [lib/hooks/use-tags.ts](file://lib/hooks/use-tags.ts#L6)
- [lib/api/client.ts](file://lib/api/client.ts#L8)

## 状态流示意图

状态流示意图展示了前端数据流动的完整生命周期，从用户交互到状态更新再到UI渲染的全过程。

```mermaid
flowchart LR
A[用户交互] --> B[触发事件]
B --> C[调用状态方法]
C --> D[更新状态]
D --> E[通知订阅者]
E --> F[重新渲染组件]
F --> G[更新UI]
G --> A
subgraph "状态管理"
D
E
end
subgraph "数据持久化"
H[调用API]
I[获取/更新数据]
J[返回结果]
C --> H
H --> I
I --> J
J --> C
end
subgraph "UI渲染"
F
G
end
```

**图示来源**  
- [app/page.tsx](file://app/page.tsx#L76-L98)
- [lib/store/item-store.ts](file://lib/store/item-store.ts#L55-L89)
- [lib/hooks/use-items.ts](file://lib/hooks/use-items.ts#L34-L45)