# 数据模型

<cite>
**本文档引用的文件**
- [lib/types/item.ts](file://lib/types/item.ts)
- [lib/db/repository.ts](file://lib/db/repository.ts)
- [lib/db/sqlite.ts](file://lib/db/sqlite.ts)
- [lib/utils/item-utils.ts](file://lib/utils/item-utils.ts)
- [app/api/items/route.ts](file://app/api/items/route.ts)
- [需求说明.md](file://需求说明.md)
</cite>

## 目录
1. [简介](#简介)
2. [Item实体核心结构](#item实体核心结构)
3. [数据库表结构设计](#数据库表结构设计)
4. [字段详细说明](#字段详细说明)
5. [归档机制与日均价格计算](#归档机制与日均价格计算)
6. [数据生命周期管理](#数据生命周期管理)
7. [示例数据](#示例数据)
8. [架构图](#架构图)
9. [总结](#总结)

## 简介

本文档详细描述了记账应用中的Item实体数据模型设计。Item实体是整个应用的核心数据结构，用于记录个人物品的基本信息、使用成本计算和归档状态管理。该模型采用SQLite数据库存储，支持单用户模式下的物品成本管理功能。

## Item实体核心结构

Item实体定义了物品的完整信息结构，包含基础属性、业务状态和同步信息等多个维度的数据。

```mermaid
classDiagram
class Item {
+number id
+string remote_id
+string name
+string purchased_at
+number price_cents
+string remark
+number archived
+string archived_at
+number archived_daily_price_cents
+number sync_status
+string last_synced_at
+string created_at
+string updated_at
+number version
+number is_deleted
}
class CreateItemDTO {
+string name
+string purchased_at
+number price_cents
+string remark
}
class UpdateItemDTO {
+string name
+string purchased_at
+number price_cents
+string remark
+number archived
+string archived_at
+number archived_daily_price_cents
}
class ItemWithStats {
+number usage_days
+number daily_price_cents
}
Item <|-- ItemWithStats : "扩展"
Item --> CreateItemDTO : "创建时使用"
Item --> UpdateItemDTO : "更新时使用"
```

**图表来源**
- [lib/types/item.ts](file://lib/types/item.ts#L9-L25)
- [lib/types/item.ts](file://lib/types/item.ts#L30-L48)
- [lib/types/item.ts](file://lib/types/item.ts#L90-L93)

**章节来源**
- [lib/types/item.ts](file://lib/types/item.ts#L1-L94)

## 数据库表结构设计

Item实体在SQLite数据库中对应`items`表，采用关系型数据库设计，支持完整的CRUD操作和数据完整性约束。

```mermaid
erDiagram
ITEMS {
integer id PK
text user_id
text name
text purchased_at
integer price_cents
text remark
integer archived
text archived_at
integer archived_daily_price_cents
text created_at
text updated_at
}
TAGS {
integer id PK
text user_id
text name
text color
text created_at
}
ITEM_TAGS {
integer id PK
integer item_id FK
integer tag_id FK
text created_at
}
USERS {
integer id PK
text user_id UK
text username UK
text password
text created_at
text updated_at
}
ITEMS ||--o{ ITEM_TAGS : "关联"
TAGS ||--o{ ITEM_TAGS : "关联"
USERS ||--o{ ITEMS : "拥有"
```

**图表来源**
- [lib/db/sqlite.ts](file://lib/db/sqlite.ts#L29-L42)
- [lib/db/sqlite.ts](file://lib/db/sqlite.ts#L47-L54)
- [lib/db/sqlite.ts](file://lib/db/sqlite.ts#L59-L67)

**章节来源**
- [lib/db/sqlite.ts](file://lib/db/sqlite.ts#L27-L109)

## 字段详细说明

### 基础属性字段

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| `id` | INTEGER | PRIMARY KEY, AUTOINCREMENT | 本地主键，自增生成的唯一标识符 |
| `remote_id` | TEXT | NULLABLE | 云端记录ID（UUID格式），支持多设备同步 |
| `name` | TEXT | NOT NULL | 物品名称，必填字段，最大长度限制由前端控制 |
| `purchased_at` | TEXT | NOT NULL | 购买日期，ISO 8601日期字符串（YYYY-MM-DD） |
| `price_cents` | INTEGER | NOT NULL | 购买价格，以"分"为单位的整数值，最小值为0 |

### 状态管理字段

| 字段名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `archived` | INTEGER | 0 | 归档状态：0=进行中，1=已归档 |
| `archived_at` | TEXT | NULL | 归档时间，ISO 8601时间字符串，未归档时为NULL |
| `archived_daily_price_cents` | INTEGER | NULL | 归档时锁定的日均价格（分），未归档时为NULL |

### 同步与版本控制字段

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `sync_status` | INTEGER | 同步状态：0=未同步，1=已同步，2=待更新，3=待删除 |
| `last_synced_at` | TEXT | 最近一次同步成功时间，ISO 8601时间字符串 |
| `version` | INTEGER | 版本号，用于冲突解决和乐观锁控制 |

### 时间戳字段

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `created_at` | TEXT | 记录创建时间，ISO 8601时间字符串 |
| `updated_at` | TEXT | 最近更新时间，ISO 8601时间字符串 |

### 软删除字段

| 字段名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `is_deleted` | INTEGER | 0 | 软删除标记：0=正常，1=已删除 |

**章节来源**
- [lib/types/item.ts](file://lib/types/item.ts#L9-L25)
- [lib/db/sqlite.ts](file://lib/db/sqlite.ts#L30-L42)

## 归档机制与日均价格计算

### 归档状态逻辑

归档机制是Item实体的核心业务特性，用于锁定物品的最终使用成本。当物品被归档时，系统会自动计算并锁定日均价格，确保历史数据的准确性。

```mermaid
flowchart TD
Start([开始归档]) --> CheckCurrent["检查当前状态"]
CheckCurrent --> IsArchived{"是否已归档?"}
IsArchived --> |是| NoAction["无需操作"]
IsArchived --> |否| CalcUsage["计算使用天数"]
CalcUsage --> CalcPrice["计算日均价格"]
CalcPrice --> UpdateFields["更新归档字段"]
UpdateFields --> SetArchived["设置archived=1"]
SetArchived --> SetArchivedAt["设置archived_at"]
SetArchivedAt --> SetDailyPrice["设置archived_daily_price_cents"]
SetDailyPrice --> UpdateTimestamp["更新updated_at"]
UpdateTimestamp --> Complete([归档完成])
NoAction --> Complete
```

**图表来源**
- [lib/db/repository.ts](file://lib/db/repository.ts#L137-L143)
- [lib/utils/item-utils.ts](file://lib/utils/item-utils.ts#L60-L66)

### 日均价格计算算法

日均价格计算遵循严格的业务规则，确保成本计算的准确性和一致性。

```mermaid
flowchart TD
Input["输入：price_cents, purchased_at, archived_at"] --> CheckArchived{"是否已归档?"}
CheckArchived --> |是| UseLocked["使用锁定的日均价格<br/>archived_daily_price_cents"]
CheckArchived --> |否| CalcUsage["计算使用天数<br/>usage_days = endDate - startDate"]
CalcUsage --> ValidateDays{"使用天数 >= 1?"}
ValidateDays --> |否| ForceOne["强制使用天数 = 1"]
ValidateDays --> |是| CalcPrice["计算日均价格<br/>daily_price = price_cents / usage_days"]
ForceOne --> CalcPrice
CalcPrice --> Floor["向下取整<br/>Math.floor()"]
Floor --> Output["输出：日均价格分"]
UseLocked --> Output
```

**图表来源**
- [lib/utils/item-utils.ts](file://lib/utils/item-utils.ts#L12-L32)
- [lib/utils/item-utils.ts](file://lib/utils/item-utils.ts#L59-L66)

### 使用天数计算规则

使用天数计算采用自然日粒度，确保业务逻辑的一致性：

1. **未归档物品**：使用天数 = 当前日期 - 购买日期
2. **已归档物品**：使用天数 = 归档日期 - 购买日期
3. **最小值保护**：无论哪种情况，使用天数至少为1天
4. **日期处理**：忽略具体时间点，仅比较日期部分

**章节来源**
- [lib/utils/item-utils.ts](file://lib/utils/item-utils.ts#L12-L32)
- [lib/utils/item-utils.ts](file://lib/utils/item-utils.ts#L59-L73)

## 数据生命周期管理

### 创建流程

物品创建遵循严格的验证和初始化流程，确保数据完整性。

```mermaid
sequenceDiagram
participant Client as 客户端
participant API as API层
participant Validator as 验证器
participant Repo as 仓库层
participant DB as 数据库
Client->>API : POST /api/items
API->>Validator : 验证请求数据
Validator->>Validator : 检查必填字段
Validator->>Validator : 验证价格格式
Validator-->>API : 验证通过
API->>Repo : createItem(CreateItemDTO)
Repo->>DB : INSERT语句
DB-->>Repo : 返回新记录ID
Repo->>Repo : 获取完整记录
Repo-->>API : 返回Item对象
API-->>Client : 返回创建结果
```

**图表来源**
- [app/api/items/route.ts](file://app/api/items/route.ts#L34-L66)
- [lib/db/repository.ts](file://lib/db/repository.ts#L37-L63)

### 更新流程

物品更新支持部分字段更新，采用动态SQL构建确保灵活性。

```mermaid
sequenceDiagram
participant Client as 客户端
participant API as API层
participant Repo as 仓库层
participant DB as 数据库
Client->>API : PUT /api/items/ : id
API->>API : 构建更新字段列表
API->>Repo : updateItem(id, UpdateItemDTO)
Repo->>Repo : 动态构建SQL
Repo->>DB : UPDATE语句
DB-->>Repo : 返回影响行数
Repo->>Repo : 检查更新结果
Repo-->>API : 返回Item或null
API-->>Client : 返回更新结果
```

**图表来源**
- [lib/db/repository.ts](file://lib/db/repository.ts#L69-L121)
- [app/api/items/route.ts](file://app/api/items/route.ts#L1-L75)

### 归档与取消归档

归档操作涉及多个字段的状态变更，需要确保数据一致性。

| 操作 | archived | archived_at | archived_daily_price_cents |
|------|----------|-------------|----------------------------|
| 归档 | 1 | 当前时间 | 计算的每日价格 |
| 取消归档 | 0 | null | null |

### 删除流程

系统采用软删除策略，保留数据历史记录。

```mermaid
flowchart TD
DeleteRequest["删除请求"] --> SoftDelete["设置is_deleted=1"]
SoftDelete --> UpdateTimestamp["更新updated_at"]
UpdateTimestamp --> ArchiveRecords["归档相关记录"]
ArchiveRecords --> CascadeDelete["级联删除关联数据"]
CascadeDelete --> Complete["删除完成"]
```

**图表来源**
- [lib/db/repository.ts](file://lib/db/repository.ts#L127-L132)
- [lib/db/sqlite.ts](file://lib/db/sqlite.ts#L64-L66)

**章节来源**
- [lib/db/repository.ts](file://lib/db/repository.ts#L37-L156)
- [lib/utils/item-utils.ts](file://lib/utils/item-utils.ts#L1-L74)

## 示例数据

以下是符合Item实体规范的示例数据记录：

### 活跃物品示例

| 字段 | 值 |
|------|-----|
| id | 1 |
| name | "MacBook Pro" |
| purchased_at | "2024-01-01" |
| price_cents | 120000 |
| archived | 0 |
| archived_at | null |
| archived_daily_price_cents | null |
| created_at | "2024-01-01T10:00:00Z" |
| updated_at | "2024-01-01T10:00:00Z" |

### 已归档物品示例

| 字段 | 值 |
|------|-----|
| id | 2 |
| name | "旧手机" |
| purchased_at | "2023-06-15" |
| price_cents | 25000 |
| archived | 1 |
| archived_at | "2024-01-01T15:30:00Z" |
| archived_daily_price_cents | 150 |
| created_at | "2023-06-15T09:00:00Z" |
| updated_at | "2024-01-01T15:30:00Z" |

### 计算示例

对于活跃物品"MacBook Pro"：
- 购买日期：2024-01-01
- 当前日期：2024-03-15（假设）
- 使用天数：73天
- 日均价格：120000 ÷ 73 ≈ 1644分

对于已归档物品"旧手机"：
- 购买日期：2023-06-15
- 归档日期：2024-01-01
- 使用天数：169天
- 日均价格：25000 ÷ 169 ≈ 148分（已锁定）

**章节来源**
- [需求说明.md](file://需求说明.md#L182-L212)

## 架构图

### 整体数据模型架构

```mermaid
graph TB
subgraph "前端层"
UI[用户界面]
Forms[表单组件]
Lists[列表组件]
end
subgraph "API层"
ItemAPI[物品API]
AuthAPI[认证API]
end
subgraph "业务逻辑层"
ItemService[物品服务]
Utils[工具函数]
Validators[验证器]
end
subgraph "数据访问层"
ItemRepo[物品仓库]
TagRepo[标签仓库]
UserRepo[用户仓库]
end
subgraph "数据库层"
SQLite[(SQLite数据库)]
ItemsTable[items表]
TagsTable[tags表]
ItemTagsTable[item_tags表]
end
UI --> Forms
UI --> Lists
Forms --> ItemAPI
Lists --> ItemAPI
ItemAPI --> ItemService
ItemService --> Utils
ItemService --> Validators
ItemService --> ItemRepo
ItemRepo --> SQLite
SQLite --> ItemsTable
SQLite --> TagsTable
SQLite --> ItemTagsTable
```

**图表来源**
- [lib/db/repository.ts](file://lib/db/repository.ts#L1-L156)
- [lib/db/sqlite.ts](file://lib/db/sqlite.ts#L1-L109)
- [app/api/items/route.ts](file://app/api/items/route.ts#L1-L75)

### 数据流图

```mermaid
flowchart LR
subgraph "数据输入"
Form[用户表单]
API[API请求]
end
subgraph "数据验证"
TypeCheck[类型检查]
BusinessRule[业务规则验证]
ConstraintCheck[约束检查]
end
subgraph "数据处理"
CalcUsage[计算使用天数]
CalcPrice[计算日均价格]
FormatData[格式化数据]
end
subgraph "数据存储"
Insert[插入记录]
Update[更新记录]
Archive[归档处理]
end
Form --> TypeCheck
API --> TypeCheck
TypeCheck --> BusinessRule
BusinessRule --> ConstraintCheck
ConstraintCheck --> CalcUsage
CalcUsage --> CalcPrice
CalcPrice --> FormatData
FormatData --> Insert
FormatData --> Update
FormatData --> Archive
```

**图表来源**
- [app/api/items/route.ts](file://app/api/items/route.ts#L39-L66)
- [lib/utils/item-utils.ts](file://lib/utils/item-utils.ts#L12-L32)

## 总结

Item实体数据模型设计体现了以下核心设计理念：

1. **业务导向**：围绕物品成本管理的核心业务需求设计字段结构
2. **数据完整性**：通过约束和验证确保数据质量
3. **性能优化**：合理设计索引和查询策略
4. **扩展性**：预留字段支持未来功能扩展
5. **一致性**：归档机制确保历史数据的准确性

该数据模型为个人物品成本管理提供了坚实的基础，支持完整的生命周期管理和复杂的业务计算逻辑。通过清晰的字段定义、严格的约束条件和完善的归档机制，确保了系统的可靠性和用户体验的连续性。