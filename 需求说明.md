# 个人物品成本管理 Web 应用 - 需求说明

## 1. 项目背景与目标

- **目标用户**：个人用户（自己使用）。
- **使用场景**：记录日常购买的物品（电子产品、家居用品、工具等），了解物品使用成本，并支持云端数据存储和多设备访问。
- **主要目标**：
  - 管理物品的基本信息与状态。
  - 自动计算物品的使用天数与日均价格。
  - 支持物品"退役/归档"，归档后锁定日均价格。
  - 支持云端数据库存储，实现数据持久化和云端备份。
  - 基于 Next.js 的现代 Web 应用，支持多设备浏览器访问。

## 2. 功能需求

### 2.1 物品信息管理与成本计算

#### 2.1.1 物品信息字段

每个物品至少包含以下字段：

- `名称`（必填，字符串）
- `购买时间`（必填，日期，精确到日即可）
- `购买价格`（必填，数字，建议内部以“分”为单位存储整数）
- `备注`（可选，字符串）
- `创建时间`（系统生成，ISO 时间字符串）
- `更新时间`（系统生成，ISO 时间字符串）

> 可根据实际需求扩展字段，如分类、标签、购买渠道等。

#### 2.1.2 使用天数计算

- 定义：  
  使用天数 = 终止日期 - 购买日期
- 终止日期规则：
  - 对于未归档物品：终止日期 = 当前日期。
  - 对于已归档物品：终止日期 = 归档日期（锁定时刻）。
- 计算规则：
  - 以自然日为粒度（忽略具体时间点）。
  - 若终止日期与购买日期为同一天，使用天数至少按 1 天计算，避免出现除以 0 的情况。
- 展示形式：
  - 示例：`已使用 123 天`，或 `使用 365 天后归档`。

#### 2.1.3 日均价格计算

- 定义：  
  日均价格 = 购买价格 ÷ 使用天数
- 计算规则：
  - 内部以“分”为单位进行整数运算，前端展示时转换为“元”，保留 2 位小数。
  - 使用天数为 0 时，按 1 天计算。
- 展示形式：
  - 示例：`日均成本：￥1.23 / 天`。
- 更新机制：
  - **未归档物品**：日均价格随当前日期变化（使用天数增加，日均价格动态更新）。
  - **已归档物品**：日均价格锁定，不再随时间变化（归档逻辑见 2.2）。

### 2.2 物品归档 / 退役机制

#### 2.2.1 归档概念

- 归档（或退役）表示物品已经结束使用：丢弃、捐赠、转卖等。
- 归档的目的：
  - 锁定物品的最终使用成本（日均价格）。
  - 区分“正在使用中”的物品与“历史物品”。

#### 2.2.2 归档操作

- 在物品列表或详情页提供“归档/退役”操作入口。
- 用户点击归档时，系统执行：
  1. 获取当前日期作为归档日期。
  2. 根据“购买日期”和“归档日期”计算最终使用天数。
  3. 根据最终使用天数，计算归档日均价格。
  4. 将计算出的日均价格写入“归档日均价格”字段。
  5. 将物品状态设为“已归档”，记录归档时间。

#### 2.2.3 归档后的行为

- 日均价格锁定：
  - 展示时直接使用“归档日均价格”，不再根据当前日期重算。
- 使用天数展示：
  - 使用归档时的最终使用天数，例如：`使用 365 天后归档`。
- 列表与筛选：
  - 支持筛选：只看进行中 / 只看已归档 / 全部。
  - 已归档物品需有明显的状态标识。

#### 2.2.4 取消归档（可选）

- 可选需求：支持将已归档物品重新标记为“进行中”。
- 取消归档行为：
  - 状态恢复为“未归档”。
  - 日均价格恢复为随当前日期变化的动态计算。
  - 是否清空“归档日均价格”和“归档时间”可以在实现时确定。

## 3. 云端数据存储

### 3.1 数据持久化

- **目标**：
  - 将用户数据存储在云端数据库，确保数据持久化和安全备份。
  - 支持多设备（不同浏览器、不同电脑）访问同一账户数据。
  - 确保归档状态、使用天数相关字段、日均价格相关字段等关键信息正确存储。
- **范围**：
  - 主要存储 `items` 表。
  - 后续如引入分类/标签等，也可纳入数据库。

### 3.2 用户认证

- **单用户模式**（初版）：
  - 简化认证流程，支持单一用户登录。
  - 使用简单的密码或 Token 认证。
- **多用户支持**（后续扩展）：
  - 支持用户注册和登录。
  - 每个用户拥有独立的数据空间。

## 4. 技术栈与整体架构

### 4.1 前端技术栈

- **框架**：Next.js 16 (App Router)
  - 提供现代化的 React Web 应用开发体验。
  - 支持服务端渲染（SSR）和客户端渲染（CSR）。
  - 内置 API Routes，简化后端开发。
- **UI 框架**：
  - React 19 - 前端核心库
  - Tailwind CSS 4 - 样式框架
- **状态管理**：Zustand - 轻量级状态管理
- **类型检查**：TypeScript - 类型安全
- **日期处理**：date-fns - 日期计算工具

### 4.2 后端技术栈

- **运行环境**：Node.js
- **框架**：Next.js API Routes
  - 直接使用 Next.js 的 API Routes 作为后端。
  - 简化部署，前后端一体化。
- **数据库**：SQLite
  - 轻量级关系型数据库。
  - 适合个人项目，无需额外数据库服务器。
  - 可使用 `better-sqlite3` 或其他 SQLite 库。
- **认证**：
  - 使用 JWT Token 进行用户认证。
  - 初版支持单用户模式。
- **部署**：
  - 可部署到个人服务器（VPS）。
  - 也可部署到 Vercel 等平台（需要配置数据库）。

## 5. 数据模型设计

### 5.1 数据库表：`items`

| 字段名                        | 类型      | 说明                                           |
|------------------------------|-----------|----------------------------------------------|
| `id`                         | INTEGER   | 主键，自增                                    |
| `user_id`                    | TEXT      | 所属用户 ID（单用户模式下可为固定值）         |
| `name`                       | TEXT      | 物品名称                                      |
| `purchased_at`               | TEXT      | 购买日期（ISO 日期字符串）                    |
| `price_cents`                | INTEGER   | 购买价格（以"分"为单位）                      |
| `remark`                     | TEXT      | 备注                                          |
| `archived`                   | INTEGER   | 是否归档（0=否，1=是）                        |
| `archived_at`                | TEXT      | 归档时间（ISO 字符串，未归档则为空）         |
| `archived_daily_price_cents` | INTEGER   | 归档时锁定的日均价格（分，未归档则为空）     |
| `created_at`                 | TEXT      | 记录创建时间（ISO 字符串）                    |
| `updated_at`                 | TEXT      | 最近更新时间（ISO 字符串）                    |

> 日均价格展示逻辑：
> - 未归档：根据 `purchased_at` 和当前日期计算使用天数，使用 `price_cents / 使用天数` 计算。
> - 已归档：直接使用 `archived_daily_price_cents`。

## 6. API 接口设计

### 6.1 鉴权

- **登录接口**
  - `POST /api/auth/login`
  - 接收账号密码（或其他认证方式），返回 Token（如 JWT）。
- **后续接口鉴权方式**
  - 所有需要访问用户数据的接口通过 Header：
    - `Authorization: Bearer <token>`

### 6.2 Items 相关接口

- **创建物品**
  - `POST /api/items`
  - 请求体示例：
    ```json
    {
      "name": "MacBook Pro",
      "purchased_at": "2024-01-01",
      "price_cents": 120000,
      "remark": "工作用电脑",
      "archived": 0,
      "archived_at": null,
      "archived_daily_price_cents": null,
      "created_at": "2024-01-01T10:00:00Z",
      "updated_at": "2024-01-01T10:00:00Z"
    }
    ```
  - 响应示例：
    ```json
    {
      "id": "uuid-from-server",
      "name": "MacBook Pro",
      "purchased_at": "2024-01-01",
      "price_cents": 120000,
      "remark": "工作用电脑",
      "archived": 0,
      "archived_at": null,
      "archived_daily_price_cents": null,
      "created_at": "2024-01-01T10:00:00Z",
      "updated_at": "2024-01-01T10:00:00Z"
    }
    ```

- **更新物品**
  - `PUT /api/items/:id`
  - 请求体可与创建基本一致。
  - 响应返回更新后的完整记录。

- **删除物品**
  - `DELETE /api/items/:id`
  - 返回 204（无内容）或 200 响应。

## 7. 界面与交互需求

### 7.1 物品列表页

- 展示信息：
  - 物品名称
  - 当前日均价格（进行中：动态计算；归档：使用锁定值）
  - 使用天数（根据状态不同展示“至今日”或“至归档日”）
  - 状态标识（进行中 / 已归档）
- 功能操作：
  - 新建物品
  - 编辑物品
  - 归档/取消归档
  - 删除物品
  - 筛选：进行中 / 已归档 / 全部

### 7.2 物品详情页

- 展示内容：
  - 名称、购买时间、购买价格、备注
  - 使用天数
  - 日均价格
  - 状态（进行中 / 已归档）
  - 归档时间（若已归档）
- 操作：
  - 编辑基础信息
  - 归档 / 取消归档
  - 删除物品

### 7.3 新建 / 编辑物品页面

- 表单字段：
  - 名称（必填）
  - 购买日期（必填）
  - 购买价格（必填，可输入小数，内部转换为“分”）
  - 备注（可选）
- 表单校验：
  - 必填项不能为空。
  - 购买价格必须为非负数。
  - 购买日期不应晚于当前日期（可选校验）。

## 8. 后续扩展方向

- **分类与标签**：为物品添加分类/标签，支持按类别统计成本。
- **统计报表**：
  - 按时间段统计投入金额、归档物品数、平均日均成本等。
- **数据导出与导入**：
  - 支持导出为 CSV / JSON 文件。
  - 支持从文件导入历史数据。
- **更高级的功能**：
  - 数据可视化和图表展示。
  - 支持多币种。

## 9. 开发任务清单

### 阶段一：Web 端 MVP
- [x] 初始化 Next.js + TypeScript 项目（使用 App Router）
- [x] 实现物品列表页（含筛选功能）
- [x] 实现物品详情页（含归档/取消归档）
- [x] 实现新建/编辑物品表单与校验
- [x] 前端状态管理和 UI 交互

### 阶段二：云端 API 与数据库
- [x] 设计并实现云端数据库（SQLite）
- [x] 实现用户认证（单用户模式）
- [x] 实现 Items CRUD API
- [x] 前端集成 API 调用
- [x] 数据持久化测试

### 阶段三：优化与扩展
- [ ] 添加分类/标签功能
- [ ] 实现数据统计报表
- [ ] 数据导入/导出功能
- [ ] 性能优化和用户体验改进
- [ ] 部署到生产环境

## 10. 总结

本项目是一个面向个人的 **物品成本管理 Web 应用**，具备以下特点：

1. 基于 Next.js 的现代化 Web 应用，支持多设备浏览器访问。
2. 清晰的使用天数和日均价格计算逻辑，支持归档时锁定最终成本。
3. 云端数据库存储，确保数据持久化和安全备份。
4. 技术栈简洁高效：Next.js + TypeScript + SQLite，易于开发和部署。
5. 单用户模式设计，专注于个人使用场景。
